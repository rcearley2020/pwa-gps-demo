<!-- Updated app.js -->
let db;

// Initialize SQLite
initSqlJs({
  locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
}).then(SQL => {
  db = new SQL.Database();
  db.run("CREATE TABLE IF NOT EXISTS items (id INTEGER PRIMARY KEY, name TEXT);");

  document.getElementById("insertBtn").onclick = () => {
    const value = "Item " + Date.now();
    db.run("INSERT INTO items (name) VALUES (?)", [value]);
    showPopup(`Inserted: ${value}`);
  };

  document.getElementById("queryBtn").onclick = () => {
    const res = db.exec("SELECT * FROM items");
    const outputEl = document.getElementById("outputList");
    outputEl.innerHTML = "";

    if (res.length === 0 || res[0].values.length === 0) {
      outputEl.innerHTML = `<div class="output-list-item">No rows found.</div>`;
      return;
    }

    res[0].values.forEach(row => {
      const [id, name] = row;
      const div = document.createElement("div");
      div.className = "output-list-item";
      div.textContent = `ID: ${id} | Name: ${name}`;
      outputEl.appendChild(div);

      // Tap
      div.addEventListener("click", () => {
        showPopup(`Tapped on: ${name}`);
      });

      // Long press
      let pressTimer;
      div.addEventListener("mousedown", () => {
        pressTimer = setTimeout(() => showPopup(`Long pressed: ${name}`), 600);
      });
      div.addEventListener("mouseup", () => clearTimeout(pressTimer));
      div.addEventListener("mouseleave", () => clearTimeout(pressTimer));
      div.addEventListener("touchstart", () => {
        pressTimer = setTimeout(() => showPopup(`Long pressed: ${name}`), 600);
      });
      div.addEventListener("touchend", () => clearTimeout(pressTimer));

      // Swipe left
      let touchStartX = null;
      div.addEventListener("touchstart", e => {
        touchStartX = e.changedTouches[0].screenX;
      });
      div.addEventListener("touchend", e => {
        if (touchStartX !== null) {
          const diff = touchStartX - e.changedTouches[0].screenX;
          if (diff > 80) {
            showPopup(`Deleted (simulated): ${name}`);
          }
          touchStartX = null;
        }
      });
    });
  };
});

// Leaflet map setup
let map;
function initMap(lat, lng) {
  if (map) {
    map.setView([lat, lng], 13);
    setTimeout(() => map.invalidateSize(), 200);
    return;
  }
  map = L.map("map").setView([lat, lng], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  }).addTo(map);
  L.marker([lat, lng]).addTo(map)
    .bindPopup("You are here!")
    .openPopup();
  setTimeout(() => map.invalidateSize(), 200);
}

// Geolocation
function getLocation() {
  if (!navigator.geolocation) {
    alert("Geolocation is not supported by your browser.");
    return;
  }
  navigator.geolocation.getCurrentPosition(
    position => initMap(position.coords.latitude, position.coords.longitude),
    () => alert("Unable to retrieve your location.")
  );
}
